<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>youtubeAPI</title>
    <link rel="shortcut Icon" type="image/x-icon" href="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://vjs.zencdn.net/7.8.4/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.8.4/video.js"></script>
    <link href="common.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <div class="video-container">
            <div class="tab-nav" tab-group="videoList">
                <button class="tab-btn btn active" tab-target="video_default">Default</button>
                <button class="tab-btn btn" tab-target="video_collect">Collect</button>
            </div>
            <div class="tab-content" tab-group="videoList">
                <div id="video_default" class="tab-pane">
                    <div class="video-row"></div>
                    <div class="pagination"></div>
                </div>
                <div id="video_collect" class="tab-pane">
                    <div class="video-row"></div>
                    <div class="pagination"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let url = new URL(window.location.href)
        let searchParams = new URLSearchParams(url.search)

        if (searchParams.has('page')) {
            console.log(searchParams.get('page'))
        }

        // defaultAPI
        const youtubeAPI = 'https://www.googleapis.com/youtube/v3/videos' +
            // '?part=snippet,contentDetails,id,liveStreamingDetails,statistics,status' +
            '?part=snippet,contentDetails,id' +
            '&regionCode=tw' +
            '&chart=mostPopular' +
            '&maxResults=50' +
            '&key=AIzaSyBP-Du-hT1dfrn7JikjtPr6eqfSjtJlUy0'

        let gAllVideoItems = [];
        let gShowPaneId = 'video_default'
        const gShowPerPage = 12;

        $(function () {
            getVideoItems(youtubeAPI, true)

            var testurl = "https://www.googleapis.com/youtube/v3/videos" +
                "?id=V0TMHRijVDw,aTS9n_m7TW0" +
                "&key=AIzaSyBP-Du-hT1dfrn7JikjtPr6eqfSjtJlUy0" +
                "&part=snippet"
            $.get(testurl, function (res) {
                console.log(res);
            })

            tab();
        })

        // 打Ajax
        function getVideoItems(url, firstLoading) {
            $('#' + gShowPaneId).addClass('loading');
            $.get(url, function (res) {
                // 將拿到的 items 合併到 gAllVideoItems 儲存
                gAllVideoItems = gAllVideoItems.concat(res.items)

                // 第一次打API
                // if (firstLoading) {
                //     gTotalVideoItems = res.pageInfo.totalResults
                // }

                // 是否還有下一個API?
                // let nextPageToken = res.nextPageToken ? res.nextPageToken : false
                // if (nextPageToken) {
                //     let newUrl = youtubeAPI + '&pageToken=' + nextPageToken
                //     getVideoItems(newUrl)
                // } else {
                //     render_VideoPane(1)
                //     console.log(gAllVideoItems)
                // }

                // 配合100筆
                if (firstLoading) {
                    let nextPageToken = res.nextPageToken ? res.nextPageToken : false
                    let newUrl = youtubeAPI + '&pageToken=' + nextPageToken
                    getVideoItems(newUrl)
                } else {
                    render_VideoPane(1)
                    console.log(gAllVideoItems)
                }
            })
        }

        // 回傳html -- 視頻清單
        function layout_VideoList(nowPage) {
            let htmlLayout = "";
            let ls = localStorage.getItem('collectId') // 收藏array;
            if (ls) {
                ls = JSON.parse(ls);
            } else {
                ls = [];
            }
            let startItem = gShowPerPage * (nowPage - 1)
            let endItem = gAllVideoItems.length < (startItem + gShowPerPage) ?
                gAllVideoItems.length :
                startItem + gShowPerPage

            for (let i = startItem; i < endItem; i++) {

                let ele = gAllVideoItems[i]
                // videoItems.forEach(ele => { 替代
                let vid = ele.id
                let snippet = ele.snippet
                let title = snippet.localized.title
                let desc = snippet.localized.description

                let img = snippet.thumbnails.default.url
                if (snippet.thumbnails.standard) {
                    img = snippet.thumbnails.standard.url
                }

                let added = ''; // collected or not;
                if (ls) {
                    ls.forEach((ele, idx) => {
                        if (vid === ele) {
                            added = 'added';
                        }
                    });
                }

                htmlLayout += `
                    <div class="video-col">
                        <div id="${vid}" class="video_card">
                            <div class="video_img">
                                <img class="img" src="${img}">
                                <div class="btn collect ${added}" onclick="clickCollect(this);"><i class="fa fa-star"></i></div>
                                <div class="timeLength">12:34</div>
                            </div>
                            <div class="video_desc">
                                <div class="title text-more2">${title}</div>
                                <div class="desc text-more2">${desc}</div>
                            </div>
                        </div>
                    </div>
                `
            };

            return htmlLayout;
        }

        // 回傳html -- 頁籤
        function layout_Pagination(nowPage) {
            let minPage = 1;
            let maxPage = Math.ceil(gAllVideoItems.length / gShowPerPage); // 無條件進位

            let minPageHtml = `<button class="btn page-btn" onclick="render_VideoPane(${minPage})">${minPage}</button>`
            let maxPageHtml = `<button class="btn page-btn" onclick="render_VideoPane(${maxPage})">${maxPage}</button>`

            let prevPageHtml = (nowPage === minPage) ?
                `<button class="btn page-btn" disabled>prev</button>` :
                `<button class="btn page-btn" onclick="render_VideoPane(${nowPage - 1})">prev</button>`

            let nextPageHtml = (nowPage === maxPage) ?
                `<button class="btn page-btn" disabled>next</button>` :
                `<button class="btn page-btn" onclick="render_VideoPane(${nowPage + 1})">next</button>`

            let fivePagesHtml = ''
            let fivePages_first = nowPage - 2;

            for (let i = -2; i <= 2; i++) {
                if (nowPage + i < minPage) {
                    fivePages_first++;
                }
                if (nowPage + i > maxPage) {
                    fivePages_first--;
                }
            }

            for (let i = 0; i < 5; i++) {
                if (fivePages_first + i === nowPage) {
                    fivePagesHtml += `<button class="btn page-btn active">${fivePages_first + i}</button>`
                } else {
                    fivePagesHtml += `<button class="btn page-btn" onclick="render_VideoPane(${fivePages_first + i})">${fivePages_first + i}</button>`
                }
            }

            let htmlLayout = `
                ${minPageHtml}
                ${prevPageHtml}
                ${fivePagesHtml}
                ${nextPageHtml}
                ${maxPageHtml}
            `
            return htmlLayout;
        }

        // 畫面輸出 -- 視頻清單 + 頁籤
        function render_VideoPane(page) {
            $('#' + gShowPaneId).addClass('loading');

            let video_default_Html = layout_VideoList(page);
            $('#' + gShowPaneId + ' > .video-row').html(video_default_Html);

            let video_default_pagination = layout_Pagination(page);
            $('#' + gShowPaneId + ' > .pagination').html(video_default_pagination);

            $('#' + gShowPaneId).removeClass('loading');
        }

        // 按下收藏按紐時
        function clickCollect(self) {
            let vid = $(self).closest('.video_card').attr('id')
            let ls = localStorage.getItem('collectId')
            let newCollectArray = [];

            if (ls) {
                ls = JSON.parse(ls);

                let added = true;
                ls.forEach((ele, idx) => {
                    if (vid === ele) {
                        $(self).removeClass('added')
                        ls.splice(idx, 1);
                        added = false;
                    }
                });
                if (added) {
                    $(self).addClass('added')
                    newCollectArray = ls.push(vid)
                }

            } else { // first click;
                ls = [vid];
                $(self).addClass('added')
            }

            localStorage.setItem('collectId', JSON.stringify(ls))
        }

        // tab切換
        function tab() {
            $('.tab-btn').on('click', function () {
                let target = $(this).attr('tab-target');
                gShowPaneId = target;

                $('.tab-btn').removeClass('active');
                $(this).addClass('active');

                $('.tab-pane').fadeOut('fast');
                $('#' + target).fadeIn('fast');
            })
        }

    </script>
</body>

</html>